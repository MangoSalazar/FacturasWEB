@page "/Facturitas"
@using FacturasWEB.Components.Data
@using FacturasWEB.Components.Servicios
@inject ServicioControlador Controlador
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<h3>Nueva Factura</h3>

<div class="mat-card">
    <div class="row">
        <div class="col-md-8 mat-form-group">
            <label class="mat-label">Nombre del Cliente</label>
            <input type="text" class="mat-input" @bind="nuevaFactura.Nombre" placeholder="Ej. Empresa S.A." />
        </div>
        <div class="col-md-4 mat-form-group">
            <label class="mat-label">Fecha de Emisión</label>
            <input type="date" class="mat-input" @bind="fechaParaInput" />
        </div>
    </div>
</div>

<div class="mat-card" style="border-left: 5px solid var(--accent);">
    <h4><span class="bi bi-cart-plus"></span> Añadir Artículos</h4>

    <div class="row align-items-end">
        <div class="col-md-5 mat-form-group">
            <label class="mat-label">Descripción del Artículo</label>
            <input class="mat-input" @bind="nuevoArticulo.Nombre" placeholder="Ej. Monitor 24 pulgadas" />
        </div>
        <div class="col-md-3 mat-form-group">
            <label class="mat-label">Precio Unitario</label>
            <input class="mat-input" @bind="nuevoArticulo.Precio" type="number" step="1" min="0.1" />
        </div>
        <div class="col-md-2 mat-form-group">
            <label class="mat-label">Cantidad</label>
            <input class="mat-input" @bind="nuevoArticulo.Cantidad" type="number" min="1" placeholder="1" />
        </div>
        <div class="col-md-2 mat-form-group">
            <button class="mat-btn mat-btn-accent w-100" @onclick="agregarArticulo">
                Añadir
            </button>
        </div>
    </div>
</div>

<div class="mat-card">
    <h4>Resumen de Artículos</h4>

    @if (!articulos.Any())
    {
        <div class="alert alert-secondary">No hay artículos en la lista aún.</div>
    }
    else
    {
        <div class="mat-table-container">
            <table class="mat-table">
                <thead>
                    <tr>
                        <th>Descripción</th>
                        <th>Precio</th>
                        <th>Cant.</th>
                        <th>Subtotal</th>
                        <th style="text-align: right">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var art in articulos)
                    {
                        <tr>
                            <td>@art.Nombre</td>
                            <td>$@art.Precio</td>
                            <td>@art.Cantidad</td>
                            <td style="font-weight: bold; color: var(--primary-light)">
                                $@(art.Precio* art.Cantidad)
                            </td>
                            <td style="text-align: right">
                                <button class="mat-btn mat-btn-accent" style="padding: 5px 10px; font-size: 0.8rem;" @onclick="() => actualizarArticulo(art)">Editar</button>
                                <button class="mat-btn mat-btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" @onclick="() => eliminarArticulo(art)">Eliminar</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-end mt-4">
            <h3 style="color: var(--primary-dark)">Total: $@total</h3>
        </div>
    }
</div>

<div class="d-flex justify-content-between mb-5">
    <a href="lista-facturas">
        <button class="mat-btn" style="background: white; border: 1px solid #ccc;">Ver Facturas</button>
    </a>

    <button class="mat-btn mat-btn-primary" @onclick="guardarFactura">
        Guardar Factura Completa
    </button>
</div>

@if (!string.IsNullOrEmpty(mensajeError))
{
    <div class="alert alert-danger">@mensajeError</div>
}
@code {
    private Factura nuevaFactura = new Factura();
    private Articulo nuevoArticulo = new Articulo();
    private List<Articulo> articulos = new List<Articulo>();
    private DateTime fechaParaInput = DateTime.Today;
    private double total = 0.0;

    private string mensajeError = "";

    protected override async Task OnInitializedAsync()
    {
        Controlador.cargarArticulos(articulos);
        articulos = await Controlador.obtenerArticulos();
    }

    private async Task eliminarArticulo(Articulo articulo)
    {
        Controlador.eliminarArticulo(articulo);
        articulos = await Controlador.obtenerArticulos();
        total -= articulo.Precio * articulo.Cantidad;
    }

    private async Task agregarArticulo()
    {
        mensajeError = "";
        if (string.IsNullOrWhiteSpace(nuevoArticulo.Nombre) ||
        nuevoArticulo.Precio <= 0 ||
        nuevoArticulo.Cantidad <= 0)
        {
            mensajeError = "Faltan datos obligatorios del artículo";
            return;
        }
        Controlador.agregarArticulo(nuevoArticulo);
        articulos = await Controlador.obtenerArticulos();
        total += nuevoArticulo.Precio * nuevoArticulo.Cantidad;
        nuevoArticulo = new Articulo();

    }
    private async Task actualizarArticulo(Articulo articuloOriginal)
    {
        mensajeError = "";
        if (string.IsNullOrWhiteSpace(nuevoArticulo.Nombre) ||
        nuevoArticulo.Precio <= 0 ||
        nuevoArticulo.Cantidad <= 0)
        {
            mensajeError = "Faltan datos obligatorios del artículo";
            return;
        }
        Controlador.actualizarArticulo(articuloOriginal, nuevoArticulo);
        articulos = await Controlador.obtenerArticulos();
        total = articulos.Sum(a => a.Precio * a.Cantidad);
    }

    private async Task guardarFactura()
    {
        mensajeError = "";
        if (!string.IsNullOrWhiteSpace(nuevaFactura.Nombre) && articulos.Any())
        {
            nuevaFactura.Fecha = fechaParaInput.ToString("yyyy-MM-dd");
            nuevaFactura.Nombre = nuevaFactura.Nombre?.Trim();
            nuevaFactura.Articulos = articulos;
            await Controlador.guardarFactura(nuevaFactura);
            Console.WriteLine("factura añadida");
            nuevaFactura = new Factura();
            total = 0.0;
            return;
        }
        mensajeError = "Faltan datos obligatorios";

    }
}