@page "/lista-facturas"
@using FacturasWEB.Components.Data
@using FacturasWEB.Components.Servicios
@inject ServicioControlador Controlador
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Historial de Facturas</h3>
    <a href="estadisticas">
        <button class="mat-btn mat-btn-accent">Ver Estadísticas</button>
    </a>
</div>

@if (!facturasCargadas.Any())
{
    <div class="mat-card">
        <p class="text-muted text-center m-0">No hay facturas guardadas en la base de datos.</p>
    </div>
}
else
{
    <div class="mat-table-container">
        <table class="mat-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th class="text-center">Artículos</th>
                    <th style="text-align: right;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var factura in facturasCargadas)
                {
                    <tr>
                        <td>@factura.Fecha</td>
                        <td style="font-weight: 500; color: var(--primary-dark);">@factura.Nombre</td>
                        <td class="text-center"><span class="badge bg-secondary">@factura.Articulos.Count()</span></td>
                        <td style="text-align: right;">
                            <button class="mat-btn mat-btn-accent" style="padding: 6px 12px;" @onclick="() => Editar(factura)">Editar</button>
                            <button class="mat-btn mat-btn-danger" style="padding: 6px 12px;" @onclick="() => Eliminar(factura)">Eliminar</button>
                            <button class="mat-btn" style="background-color: #FFB74D; color: white; padding: 6px 12px; margin: 0 5px;" @onclick="() => Archivar(factura)">
                                <i class="bi bi-archive"></i> Archivar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
@code {

    private List<Factura> facturasCargadas;


    protected override async Task OnInitializedAsync()
    {
        facturasCargadas = await Controlador.obtenerFacturas();
    }

    private void Editar(Factura factura)
    {
        Console.WriteLine($"Editar factura ID: {factura.Nombre + factura.ID_factura}");
        NavigationManager.NavigateTo($"/EditarFactura/{factura.ID_factura}");
    }

    private async Task Eliminar(Factura factura)
    {
        Console.WriteLine($"Eliminar factura ID: {factura}");
        Controlador.eliminarFactura(factura);
        facturasCargadas = await Controlador.obtenerFacturas(); 
        Console.WriteLine("Factura eliminada y lista recargada.");
    }
    private async Task Archivar(Factura factura)
    {
        await Controlador.ArchivarFactura(factura.ID_factura);
        facturasCargadas = await Controlador.obtenerFacturas();
    }
}
